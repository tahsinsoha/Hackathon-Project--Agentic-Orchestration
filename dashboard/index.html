<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üö® Incident Autopilot - Control Tower</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      padding: 20px;
    }

    .container { max-width: 1400px; margin: 0 auto; }

    header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    h1 { color: #667eea; font-size: 2.5rem; margin-bottom: 10px; }
    .subtitle { color: #666; font-size: 1.1rem; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-label {
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }
    .stat-value { font-size: 2.5rem; font-weight: bold; color: #667eea; }
    .stat-unit { font-size: 1rem; color: #999; }

    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .panel {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
      gap: 12px;
      flex-wrap: wrap;
    }

    .panel-title { font-size: 1.5rem; font-weight: bold; color: #333; }

    .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    select {
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      font-size: 1rem;
      cursor: pointer;
      background: white;
    }

    .button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .button:hover { background: #5568d3; transform: scale(1.05); }
    .button:active { transform: scale(0.95); }
    .button-secondary { background: #f59e0b; }
    .button-secondary:hover { background: #d97706; }

    .incident-list { max-height: 600px; overflow-y: auto; }

    .incident-card {
      border: 2px solid #f0f0f0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.2s;
      cursor: pointer;
    }
    .incident-card:hover {
      border-color: #667eea;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
    }

    .incident-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 12px;
    }

    .incident-id { font-weight: bold; color: #667eea; }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: bold;
      white-space: nowrap;
    }

    .badge-critical { background: #fee; color: #c00; }
    .badge-high { background: #fed; color: #f60; }
    .badge-medium { background: #ffd; color: #f90; }
    .badge-low { background: #efe; color: #0a0; }

    .badge-completed { background: #e8f5e9; color: #2e7d32; }
    .badge-in-progress { background: #fff3e0; color: #ef6c00; }
    .badge-failed { background: #ffebee; color: #c62828; }

    .incident-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      font-size: 0.9rem;
      color: #666;
    }

    .timeline { max-height: 520px; overflow-y: auto; }
    .timeline-item { position: relative; padding-left: 30px; padding-bottom: 20px; }
    .timeline-item:before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e0e0e0;
    }
    .timeline-dot {
      position: absolute;
      left: 0;
      top: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #667eea;
      border: 3px solid white;
      box-shadow: 0 0 0 2px #667eea;
    }
    .timeline-stage { font-weight: bold; color: #667eea; margin-bottom: 5px; }
    .timeline-message { color: #666; font-size: 0.9rem; }

    .loading { text-align: center; padding: 40px; color: #999; }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Simple details panel */
    .details {
      margin-top: 16px;
      padding: 14px;
      border-radius: 10px;
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      display: none;
    }
    .details h3 { margin-bottom: 10px; color: #667eea; }
    .details-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      font-size: 0.9rem;
      color: #444;
    }
    .details-grid code { background: white; padding: 2px 6px; border-radius: 6px; }

    .approve-row {
      margin-top: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .muted { color: #777; font-size: 0.9rem; }

    @media (max-width: 768px) {
      .main-content { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .incident-info { grid-template-columns: 1fr; }
      .details-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;">
        <div>
          <h1>üö® Incident Autopilot</h1>
          <p class="subtitle">Plain HTML Dashboard (FastAPI + Agents)</p>
        </div>
      </div>
    </header>

    <div class="stats-grid" id="stats">
      <div class="stat-card">
        <div class="stat-label">Total Incidents</div>
        <div class="stat-value"><span id="stat-total">0</span></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Detection Latency</div>
        <div class="stat-value">
          <span id="stat-detection">0.0</span><span class="stat-unit">s</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Time to Mitigation</div>
        <div class="stat-value">
          <span id="stat-mitigation">0.0</span><span class="stat-unit">s</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Success Rate</div>
        <div class="stat-value">
          <span id="stat-success">0</span><span class="stat-unit">%</span>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">Recent Incidents</h2>
          <div class="controls">
            <select id="incident-type">
              <option value="">Random</option>
              <option value="latency_spike">Latency Spike</option>
              <option value="error_rate">Error Rate</option>
              <option value="resource_saturation">Resource Saturation</option>
              <option value="queue_depth">Queue Depth</option>
            </select>

            <button class="button" onclick="simulateIncident()">üöÄ Simulate Incident</button>
            <button class="button button-secondary" onclick="refreshData()">üîÑ Refresh</button>
          </div>
        </div>

        <!-- Simple details panel (no Retool) -->
        <div id="details" class="details">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
            <h3 style="margin:0;">üìå Selected Incident</h3>
            <button class="button button-secondary" style="padding:8px 12px;" onclick="clearSelection()">Clear</button>
          </div>

          <div class="details-grid" style="margin-top:10px;">
            <div><strong>ID:</strong> <code id="d-id">-</code></div>
            <div><strong>Service:</strong> <span id="d-service">-</span></div>
            <div><strong>Severity:</strong> <span id="d-sev" class="badge">-</span></div>
            <div><strong>Stage:</strong> <span id="d-stage" class="badge">-</span></div>
            <div><strong>Type:</strong> <span id="d-type">-</span></div>
            <div><strong>Started:</strong> <span id="d-start">-</span></div>
            <div><strong>Ended:</strong> <span id="d-end">-</span></div>
            <div><strong>Mitigation:</strong> <span id="d-mit">-</span></div>
            <div><strong>Recovered:</strong> <span id="d-rec">-</span></div>
            <div><strong>TTM:</strong> <span id="d-ttm">-</span></div>
          </div>

          <div class="approve-row">
            <button id="approve-btn" class="button" style="display:none;" onclick="approveMitigation()">
              ‚úÖ Approve Mitigation
            </button>
            <span id="approve-hint" class="muted"></span>
          </div>

          <div style="margin-top:12px;">
            <div class="muted" style="margin-bottom:6px;"><strong>Incident Summary:</strong></div>
            <div id="d-summary" style="white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; background:white; border-radius:10px; padding:12px; border:1px solid #eee; max-height:220px; overflow:auto;">
              -
            </div>
          </div>
        </div>

        <div class="incident-list" id="incident-list">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading incidents...</p>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2 class="panel-title">Pipeline Status</h2>
        </div>
        <div class="timeline" id="timeline">
          <p style="color:#999;">Select an incident to view its timeline</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let selectedIncident = null;

    // -------------------------
    // API helpers
    // -------------------------
    async function apiGet(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error(`${path} failed (${res.status})`);
      return res.json();
    }

    async function apiPost(path) {
      const res = await fetch(path, { method: 'POST' });
      if (!res.ok) throw new Error(`${path} failed (${res.status})`);
      return res.json();
    }

    // -------------------------
    // Stats
    // -------------------------
    async function loadStatistics() {
      try {
        const stats = await apiGet('/api/statistics');
        document.getElementById('stat-total').textContent = stats.total_incidents || 0;
        document.getElementById('stat-detection').textContent = (stats.avg_detection_latency || 0).toFixed(1);
        document.getElementById('stat-mitigation').textContent = (stats.avg_time_to_mitigation || 0).toFixed(1);
        document.getElementById('stat-success').textContent = (stats.success_rate || 0).toFixed(0);
      } catch (e) {
        console.error('Failed to load statistics:', e);
      }
    }

    // -------------------------
    // Incidents list
    // -------------------------
    function getStageColor(stage) {
      if (stage === 'completed') return 'completed';
      if (stage === 'failed') return 'failed';
      return 'in-progress';
    }

    function severityClass(sev) {
      return sev ? `badge-${sev}` : '';
    }

    async function loadIncidents() {
      try {
        const data = await apiGet('/api/incidents');
        const listElement = document.getElementById('incident-list');

        if (!data.incidents || data.incidents.length === 0) {
          listElement.innerHTML = '<p style="color:#999; text-align:center; padding:40px;">No incidents yet. Click "Simulate Incident" to create one.</p>';
          return;
        }

        listElement.innerHTML = data.incidents.map(inc => `
          <div class="incident-card" onclick="selectIncident('${inc.id}')">
            <div class="incident-header">
              <span class="incident-id">${inc.id}</span>
              <span class="badge ${severityClass(inc.severity)}">${String(inc.severity || '').toUpperCase()}</span>
            </div>
            <div class="incident-info">
              <div><strong>Service:</strong> ${inc.service_name}</div>
              <div><strong>Type:</strong> ${inc.incident_type}</div>
              <div><strong>Stage:</strong>
                <span class="badge badge-${getStageColor(inc.stage)}">${inc.stage}</span>
              </div>
              <div><strong>Started:</strong> ${new Date(inc.start_time).toLocaleTimeString()}</div>
            </div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Failed to load incidents:', e);
        document.getElementById('incident-list').innerHTML = '<p style="color:#c00;">Failed to load incidents</p>';
      }
    }

    // -------------------------
    // Timeline + details
    // -------------------------
    async function selectIncident(incidentId) {
      selectedIncident = incidentId;

      try {
        const incident = await apiGet(`/api/incidents/${incidentId}`);

        // timeline
        const timelineElement = document.getElementById('timeline');
        if (!incident.timeline || incident.timeline.length === 0) {
          timelineElement.innerHTML = '<p style="color:#999;">No timeline events yet</p>';
        } else {
          timelineElement.innerHTML = incident.timeline.map(event => `
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="timeline-stage">${String(event.stage || '').toUpperCase()}</div>
              <div class="timeline-message">${event.message || ''}</div>
              <div style="color:#999; font-size:0.8rem; margin-top:5px;">
                ${new Date(event.timestamp).toLocaleTimeString()}
              </div>
            </div>
          `).join('');
        }

        // details panel
        const details = document.getElementById('details');
        details.style.display = 'block';

        document.getElementById('d-id').textContent = incident.id || '-';
        document.getElementById('d-service').textContent = incident.service_name || '-';

        const sevBadge = document.getElementById('d-sev');
        sevBadge.textContent = (incident.severity || '-').toUpperCase();
        sevBadge.className = `badge ${severityClass(incident.severity)}`;

        const stageBadge = document.getElementById('d-stage');
        stageBadge.textContent = incident.stage || '-';
        stageBadge.className = `badge badge-${getStageColor(incident.stage)}`;

        document.getElementById('d-type').textContent = incident.incident_type || '-';
        document.getElementById('d-start').textContent = incident.start_time ? new Date(incident.start_time).toLocaleString() : '-';
        document.getElementById('d-end').textContent = incident.end_time ? new Date(incident.end_time).toLocaleString() : 'ongoing';

        const mitigationDesc =
          (incident.applied_mitigation && incident.applied_mitigation.description) ||
          (incident.proposed_mitigation && incident.proposed_mitigation.description) ||
          'None';
        document.getElementById('d-mit').textContent = mitigationDesc;

        document.getElementById('d-rec').textContent = String(incident.metrics_recovered ?? '-');
        document.getElementById('d-ttm').textContent =
          incident.metrics && typeof incident.metrics.time_to_mitigation_seconds === 'number'
            ? `${incident.metrics.time_to_mitigation_seconds.toFixed(1)}s`
            : '-';

        // summary (uses your /summary endpoint, safer + smaller)
        try {
          const s = await apiGet(`/api/incidents/${incidentId}/summary`);
          document.getElementById('d-summary').textContent = s.summary || '(no summary)';
        } catch {
          document.getElementById('d-summary').textContent = '(summary not available)';
        }

        // approval button logic
        const approveBtn = document.getElementById('approve-btn');
        const approveHint = document.getElementById('approve-hint');

        const needsApproval =
          incident.proposed_mitigation &&
          incident.proposed_mitigation.requires_approval &&
          !incident.mitigation_approved &&
          !incident.applied_mitigation;

        if (needsApproval) {
          approveBtn.style.display = 'inline-block';
          approveHint.textContent = 'This incident has a proposed mitigation awaiting approval.';
        } else {
          approveBtn.style.display = 'none';
          approveHint.textContent = '';
        }

      } catch (e) {
        console.error('Failed to load incident details:', e);
      }
    }

    function clearSelection() {
      selectedIncident = null;
      document.getElementById('details').style.display = 'none';
      document.getElementById('timeline').innerHTML = '<p style="color:#999;">Select an incident to view its timeline</p>';
    }

    // -------------------------
    // Actions
    // -------------------------
    async function simulateIncident() {
      const type = document.getElementById('incident-type').value;
      const button = event.target;
      button.disabled = true;
      button.textContent = '‚è≥ Simulating...';

      try {
        const url = type
          ? `/api/incidents/simulate?incident_type=${encodeURIComponent(type)}&auto_approve=true`
          : '/api/incidents/simulate?auto_approve=true';

        const data = await apiPost(url);

        // quick refresh + select
        setTimeout(async () => {
          await refreshData();
          await selectIncident(data.incident_id);
          button.disabled = false;
          button.textContent = 'üöÄ Simulate Incident';
        }, 1200);

        // auto-refresh while processing
        const refreshInterval = setInterval(async () => {
          await loadIncidents();
          await loadStatistics();
          if (selectedIncident) await selectIncident(selectedIncident);

          try {
            const inc = await apiGet(`/api/incidents/${data.incident_id}`);
            if (inc.stage === 'completed' || inc.stage === 'failed') {
              clearInterval(refreshInterval);
            }
          } catch (_) {}
        }, 2000);

      } catch (e) {
        console.error('Failed to simulate incident:', e);
        alert('Failed to simulate incident: ' + e.message);
        button.disabled = false;
        button.textContent = 'üöÄ Simulate Incident';
      }
    }

    async function approveMitigation() {
      if (!selectedIncident) return;
      const btn = document.getElementById('approve-btn');
      btn.disabled = true;
      const old = btn.textContent;
      btn.textContent = '‚è≥ Approving...';

      try {
        await apiPost(`/api/incidents/${selectedIncident}/approve`);
        await selectIncident(selectedIncident);
      } catch (e) {
        console.error('Approve failed:', e);
        alert('Approve failed: ' + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = old;
      }
    }

    async function refreshData() {
      await loadStatistics();
      await loadIncidents();
    }

    // Initial load + periodic refresh
    refreshData();
    setInterval(refreshData, 5000);
  </script>
</body>
</html>
